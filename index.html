<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Package Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì¶</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-3 text-2xl">üì¶</span>
                Package Tracker
            </h1>
            <div id="status" class="mb-4 p-3 rounded-lg border">
                <p class="text-sm" id="status-text">Checking database connection...</p>
            </div>
            
            <!-- Add Package Form -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h2 class="text-xl font-semibold mb-4">Add New Package</h2>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input 
                        type="text" 
                        id="tracking-input" 
                        placeholder="Enter tracking number"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <input 
                        type="text" 
                        id="nickname-input" 
                        placeholder="Package nickname (optional)"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <button 
                        id="add-btn" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center"
                    >
                        <span class="mr-2">‚ûï</span>
                        Add Package
                    </button>
                </div>
            </div>
        </div>

        <!-- Packages List -->
        <div id="packages-container" class="space-y-4">
            <!-- Packages will be inserted here -->
        </div>
    </div>

    <script>
        // üî• YOUR ACTUAL API CREDENTIALS
        const SUPABASE_URL = 'https://aqyfwmbbprnyldxfkabz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxeWZ3bWJicHJueWxkeGZrYWJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxOTIyNjIsImV4cCI6MjA3MDc2ODI2Mn0.tOB-aFn1C8MIjy4ep9Y-sQGjxyf-_rsY-LIGzFSxvh8';
        const AFTERSHIP_API_KEY = 'asat_5cb664406abd48c0b57ed79775828a5c';
        
        // App state
        let packages = [];
        let isLoading = false;
        let dbConnected = false;

        // Database functions
        async function makeSupabaseRequest(endpoint, options = {}) {
            const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'apikey': SUPABASE_KEY,
                ...options.headers
            };

            const response = await fetch(url, {
                ...options,
                headers
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return response.json();
        }

        async function loadPackages() {
            try {
                updateStatus('Loading packages from database...', 'yellow');
                const data = await makeSupabaseRequest('packages?select=*&order=created_at.desc');
                packages = data;
                dbConnected = true;
                updateStatus(`‚úÖ Database connected - ${packages.length} packages loaded`, 'green');
                localStorage.setItem('packages', JSON.stringify(packages));
                renderPackages();
            } catch (error) {
                console.error('Database error:', error);
                updateStatus('‚ùå Database error - using local storage', 'red');
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('packages');
            if (saved) {
                try {
                    packages = JSON.parse(saved);
                    renderPackages();
                } catch (e) {
                    console.log('Error loading from localStorage');
                }
            }
        }

        function updateStatus(message, color) {
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = message;
            
            // Remove all color classes
            statusEl.className = 'mb-4 p-3 rounded-lg border';
            
            // Add color-specific classes
            if (color === 'green') {
                statusEl.classList.add('bg-green-50', 'border-green-200');
                statusText.classList.add('text-green-700');
            } else if (color === 'red') {
                statusEl.classList.add('bg-red-50', 'border-red-200');
                statusText.classList.add('text-red-700');
            } else {
                statusEl.classList.add('bg-yellow-50', 'border-yellow-200');
                statusText.classList.add('text-yellow-700');
            }
        }

        function detectCarrier(trackingNumber) {
            const cleaned = trackingNumber.replace(/\s+/g, '').toUpperCase();
            
            if (/^1Z[0-9A-Z]{16}$/.test(cleaned)) return 'UPS';
            if (/^[0-9]{12}$/.test(cleaned) || /^[0-9]{14}$/.test(cleaned)) return 'FedEx';
            if (/^[0-9]{15}$/.test(cleaned)) return 'FedEx';
            if (/^[0-9]{20}$/.test(cleaned)) return 'FedEx';
            if (/^(94|93|92|94)[0-9]{20}$/.test(cleaned)) return 'USPS';
            if (/^[A-Z]{2}[0-9]{9}[A-Z]{2}$/.test(cleaned)) return 'USPS';
            if (/^[0-9]{10,11}$/.test(cleaned)) return 'DHL';
            if (/^[0-9]{4}[0-9]{4}[0-9]{2}$/.test(cleaned)) return 'DHL';
            if (/^TBA[0-9]{12}$/.test(cleaned)) return 'Amazon';
            if (/^[A-Z]{2}[0-9]{9}[A-Z]{2}$/.test(cleaned)) return '17track';
            if (/^[0-9]{13}$/.test(cleaned)) return '17track';
            if (/^LP[0-9]{11}[A-Z]{2}$/.test(cleaned)) return '17track';
            if (/^[A-Z]{1}[A-Z0-9]{1}[0-9]{9}[A-Z]{2}$/.test(cleaned)) return '17track';
            if (/^YT[0-9]{16}$/.test(cleaned)) return '17track';
            
            return 'Unknown';
        }

        function getCarrierColors(carrier) {
            const colors = {
                'UPS': { primary: '#8B4513', bg: '#FFF8DC', text: '#654321' },
                'FedEx': { primary: '#4B0082', bg: '#F8F4FF', text: '#4B0082' },
                'USPS': { primary: '#004B87', bg: '#F0F8FF', text: '#003366' },
                'DHL': { primary: '#FFCC00', bg: '#FFFACD', text: '#B8860B' },
                'Amazon': { primary: '#FF9900', bg: '#FFF4E6', text: '#E47911' },
                '17track': { primary: '#2563EB', bg: '#EFF6FF', text: '#1E40AF' },
                'Unknown': { primary: '#6B7280', bg: '#F9FAFB', text: '#374151' }
            };
            return colors[carrier] || colors['Unknown'];
        }

        function getCarrierTrackingURL(carrier, trackingNumber) {
            const cleaned = trackingNumber.replace(/\s+/g, '');
            
            switch (carrier) {
                case 'UPS':
                    return `https://www.ups.com/track?tracknum=${cleaned}`;
                case 'FedEx':
                    return `https://www.fedex.com/fedextrack/?trknbr=${cleaned}`;
                case 'USPS':
                    return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${cleaned}`;
                case 'DHL':
                    return `https://www.dhl.com/us-en/home/tracking/tracking-express.html?submit=1&tracking-id=${cleaned}`;
                case 'Amazon':
                    return `https://track.amazon.com/tracking/${cleaned}`;
                case '17track':
                    return `https://www.17track.net/en/track#nums=${cleaned}`;
                default:
                    return `https://www.17track.net/en/track#nums=${cleaned}`;
            }
        }

        function getDaysUntilDelivery(deliveryDateString) {
            // Handle "Unknown" or empty delivery dates
            if (!deliveryDateString || deliveryDateString === 'Unknown' || deliveryDateString === '') {
                return { days: null, status: 'unknown' };
            }
            
            try {
                const deliveryDate = new Date(deliveryDateString);
                
                // Check if date is valid
                if (isNaN(deliveryDate.getTime())) {
                    return { days: null, status: 'unknown' };
                }
                
                const today = new Date();
                
                // Reset time to start of day for accurate day calculation
                today.setHours(0, 0, 0, 0);
                deliveryDate.setHours(0, 0, 0, 0);
                
                const diffTime = deliveryDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    return { days: Math.abs(diffDays), status: 'overdue' };
                } else if (diffDays === 0) {
                    return { days: 0, status: 'today' };
                } else if (diffDays === 1) {
                    return { days: 1, status: 'tomorrow' };
                } else {
                    return { days: diffDays, status: 'upcoming' };
                }
            } catch (error) {
                return { days: null, status: 'unknown' };
            }
        }

        function formatDaysUntilDelivery(deliveryInfo) {
            if (deliveryInfo.days === null || deliveryInfo.status === 'unknown') {
                return '<span class="text-gray-500">Delivery date unknown</span>';
            }
            
            switch (deliveryInfo.status) {
                case 'overdue':
                    return `<span class="text-red-600 font-semibold">${deliveryInfo.days} day${deliveryInfo.days > 1 ? 's' : ''} overdue</span>`;
                case 'today':
                    return '<span class="text-green-600 font-semibold">Arriving today!</span>';
                case 'tomorrow':
                    return '<span class="text-blue-600 font-semibold">Arriving tomorrow</span>';
                case 'upcoming':
                    return `<span class="text-gray-600">${deliveryInfo.days} day${deliveryInfo.days > 1 ? 's' : ''} away</span>`;
                default:
                    return '<span class="text-gray-500">Delivery date unknown</span>';
            }
        }

        // AfterShip API functions
        async function createAfterShipTracking(trackingNumber, carrier) {
            try {
                const response = await fetch('https://api.aftership.com/v4/trackings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'aftership-api-key': AFTERSHIP_API_KEY
                    },
                    body: JSON.stringify({
                        tracking: {
                            tracking_number: trackingNumber,
                            slug: getAfterShipSlug(carrier)
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`AfterShip API error: ${response.status}`);
                }

                const data = await response.json();
                return data.data.tracking;
            } catch (error) {
                console.error('Error creating AfterShip tracking:', error);
                return null;
            }
        }

        async function getAfterShipTracking(trackingNumber, carrier) {
            try {
                const slug = getAfterShipSlug(carrier);
                const response = await fetch(`https://api.aftership.com/v4/trackings/${slug}/${trackingNumber}`, {
                    headers: {
                        'aftership-api-key': AFTERSHIP_API_KEY
                    }
                });

                console.log('AfterShip response status:', response.status);
                
                if (!response.ok) {
                    console.error(`AfterShip API error: ${response.status} ${response.statusText}`);
                    return null;
                }

                const responseText = await response.text();
                console.log('AfterShip raw response:', responseText);
                
                if (!responseText.trim()) {
                    console.error('AfterShip returned empty response');
                    return null;
                }

                const data = JSON.parse(responseText);
                console.log('AfterShip parsed data:', data);
                return data.data.tracking;
            } catch (error) {
                console.error('Error fetching AfterShip tracking:', error);
                return null;
            }
        }

        function getAfterShipSlug(carrier) {
            const slugMap = {
                'UPS': 'ups',
                'FedEx': 'fedex',
                'USPS': 'usps',
                'DHL': 'dhl',
                'Amazon': 'amazon',
                '17track': 'china-post',
                'Unknown': 'auto-detect'
            };
            return slugMap[carrier] || 'auto-detect';
        }

        function formatAfterShipData(tracking) {
            if (!tracking) return null;

            // Map AfterShip status to readable format
            const statusMap = {
                'pending': 'Label Created',
                'info_received': 'Information Received',
                'in_transit': 'In Transit',
                'out_for_delivery': 'Out for Delivery',
                'delivered': 'Delivered',
                'exception': 'Exception',
                'failed_attempt': 'Failed Delivery Attempt',
                'expired': 'Expired'
            };

            const status = statusMap[tracking.tag] || tracking.tag || 'Unknown';
            
            // Get latest checkpoint for location
            const latestCheckpoint = tracking.checkpoints && tracking.checkpoints.length > 0 
                ? tracking.checkpoints[tracking.checkpoints.length - 1] 
                : null;

            const location = latestCheckpoint 
                ? `${latestCheckpoint.city || ''} ${latestCheckpoint.state || ''} ${latestCheckpoint.country_name || ''}`.trim() || 'Unknown'
                : 'Unknown';

            // Format delivery date
            const estimatedDelivery = tracking.expected_delivery 
                ? new Date(tracking.expected_delivery).toLocaleDateString()
                : 'Unknown';

            const lastUpdate = latestCheckpoint && latestCheckpoint.checkpoint_time
                ? new Date(latestCheckpoint.checkpoint_time).toLocaleString()
                : new Date().toLocaleString();

            return {
                status,
                estimated_delivery: estimatedDelivery,
                last_update: lastUpdate,
                location: location !== 'Unknown' ? location : null
            };
        }

        async function addPackage() {
            const trackingInput = document.getElementById('tracking-input');
            const nicknameInput = document.getElementById('nickname-input');
            const addBtn = document.getElementById('add-btn');
            
            const trackingNumber = trackingInput.value.trim();
            if (!trackingNumber) return;
            
            if (!AFTERSHIP_API_KEY || AFTERSHIP_API_KEY === 'YOUR_AFTERSHIP_API_KEY_HERE') {
                alert('AfterShip API key not configured. Please add your API key to get real tracking data.');
                return;
            }
            
            isLoading = true;
            addBtn.disabled = true;
            addBtn.innerHTML = '<span class="mr-2">‚è≥</span>Getting real tracking data...';
            
            try {
                const carrier = detectCarrier(trackingNumber);
                
                // Create tracking in AfterShip
                updateStatus('Creating tracking in AfterShip...', 'yellow');
                let tracking = await createAfterShipTracking(trackingNumber, carrier);
                
                // If creation failed, try to get existing tracking
                if (!tracking) {
                    updateStatus('Fetching existing tracking data...', 'yellow');
                    tracking = await getAfterShipTracking(trackingNumber, carrier);
                }
                
                let trackingData;
                if (tracking) {
                    trackingData = formatAfterShipData(tracking);
                    updateStatus('‚úÖ Real tracking data loaded from AfterShip', 'green');
                } else {
                    // Fallback to basic data if AfterShip fails
                    trackingData = {
                        status: 'Tracking Added',
                        estimated_delivery: 'Unknown',
                        last_update: new Date().toLocaleString(),
                        location: null
                    };
                    updateStatus('‚ö†Ô∏è AfterShip unavailable - tracking number saved', 'yellow');
                }
                
                const packageData = {
                    tracking_number: trackingNumber,
                    nickname: nicknameInput.value.trim() || `Package ${packages.length + 1}`,
                    carrier,
                    ...trackingData
                };

                if (dbConnected) {
                    // Save to database
                    const data = await makeSupabaseRequest('packages', {
                        method: 'POST',
                        headers: { 'Prefer': 'return=representation' },
                        body: JSON.stringify(packageData)
                    });
                    
                    packages.unshift(data[0]);
                    updateStatus(`‚úÖ Package saved with real tracking data`, 'green');
                } else {
                    // Save locally only
                    const newPackage = { id: Date.now(), ...packageData };
                    packages.unshift(newPackage);
                }
                
                trackingInput.value = '';
                nicknameInput.value = '';
                localStorage.setItem('packages', JSON.stringify(packages));
                renderPackages();
            } catch (error) {
                console.error('Error adding package:', error);
                updateStatus('‚ùå Error getting tracking data - saved locally only', 'red');
                
                // Fallback to basic local storage
                const newPackage = {
                    id: Date.now(),
                    tracking_number: trackingNumber,
                    nickname: nicknameInput.value.trim() || `Package ${packages.length + 1}`,
                    carrier: detectCarrier(trackingNumber),
                    status: 'Tracking Added',
                    estimated_delivery: 'Unknown',
                    last_update: new Date().toLocaleString(),
                    location: null
                };
                packages.unshift(newPackage);
                localStorage.setItem('packages', JSON.stringify(packages));
                renderPackages();
                
                trackingInput.value = '';
                nicknameInput.value = '';
            }
            
            isLoading = false;
            addBtn.disabled = false;
            addBtn.innerHTML = '<span class="mr-2">‚ûï</span>Add Package';
        }

        async function refreshPackage(packageId) {
            if (!AFTERSHIP_API_KEY || AFTERSHIP_API_KEY === 'YOUR_AFTERSHIP_API_KEY_HERE') {
                alert('AfterShip API key not configured. Cannot refresh tracking data.');
                return;
            }

            try {
                const pkg = packages.find(p => p.id === packageId);
                if (!pkg) return;

                updateStatus('Refreshing tracking data from AfterShip...', 'yellow');
                console.log('Refreshing package:', pkg.tracking_number, pkg.carrier);
                
                // Get updated tracking from AfterShip
                const tracking = await getAfterShipTracking(pkg.tracking_number, pkg.carrier);
                
                let updatedData;
                if (tracking) {
                    updatedData = formatAfterShipData(tracking);
                    updateStatus('‚úÖ Tracking data refreshed', 'green');
                    console.log('Formatted tracking data:', updatedData);
                } else {
                    // Keep existing data if refresh fails
                    updatedData = {
                        last_update: new Date().toLocaleString()
                    };
                    updateStatus('‚ö†Ô∏è Could not refresh - keeping existing data', 'yellow');
                    console.log('AfterShip returned no data, keeping existing data');
                }
                
                if (dbConnected) {
                    try {
                        await makeSupabaseRequest(`packages?id=eq.${packageId}`, {
                            method: 'PATCH',
                            body: JSON.stringify(updatedData)
                        });
                    } catch (dbError) {
                        console.error('Database update error:', dbError);
                        // Continue with local update even if DB fails
                    }
                }
                
                // Update local state
                const packageIndex = packages.findIndex(p => p.id === packageId);
                if (packageIndex !== -1) {
                    packages[packageIndex] = { ...packages[packageIndex], ...updatedData };
                    localStorage.setItem('packages', JSON.stringify(packages));
                    renderPackages();
                }
            } catch (error) {
                console.error('Error updating package:', error);
                updateStatus('‚ùå Error refreshing tracking data', 'red');
            }
        }

        async function removePackage(packageId) {
            try {
                if (dbConnected) {
                    await makeSupabaseRequest(`packages?id=eq.${packageId}`, {
                        method: 'DELETE'
                    });
                }
                
                packages = packages.filter(pkg => pkg.id !== packageId);
                localStorage.setItem('packages', JSON.stringify(packages));
                renderPackages();
            } catch (error) {
                console.error('Error deleting package:', error);
                // Still delete locally
                packages = packages.filter(pkg => pkg.id !== packageId);
                localStorage.setItem('packages', JSON.stringify(packages));
                renderPackages();
            }
        }

        function renderPackages() {
            const container = document.getElementById('packages-container');
            
            if (packages.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-8 text-center">
                        <div class="text-6xl mb-4">üì¶</div>
                        <p class="text-gray-500 text-lg">No packages tracked yet</p>
                        <p class="text-gray-400">Add a tracking number above to get started</p>
                    </div>
                `;
                return;
            }

            // Sort packages by estimated delivery date (earliest first)
            // Put packages with unknown delivery dates at the end
            const sortedPackages = [...packages].sort((a, b) => {
                const dateA = a.estimated_delivery === 'Unknown' ? null : new Date(a.estimated_delivery);
                const dateB = b.estimated_delivery === 'Unknown' ? null : new Date(b.estimated_delivery);
                
                // If both dates are unknown, sort by creation time (newest first)
                if (!dateA && !dateB) {
                    return b.id - a.id;
                }
                
                // Unknown dates go to the end
                if (!dateA) return 1;
                if (!dateB) return -1;
                
                // Valid dates get sorted normally (earliest first)
                return dateA - dateB;
            });

            container.innerHTML = sortedPackages.map(pkg => {
                const colors = getCarrierColors(pkg.carrier);
                const trackingURL = getCarrierTrackingURL(pkg.carrier, pkg.tracking_number);
                const deliveryInfo = getDaysUntilDelivery(pkg.estimated_delivery);
                const daysDisplay = formatDaysUntilDelivery(deliveryInfo);
                
                return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden" style="border-left: 6px solid ${colors.primary}">
                        <div class="p-6" style="background-color: ${colors.bg}">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                                <div class="flex-1">
                                    <a href="${trackingURL}" target="_blank" class="text-xl font-bold hover:underline" style="color: ${colors.text}">${pkg.nickname}</a>
                                    <p class="text-sm text-gray-600">${pkg.tracking_number}</p>
                                </div>
                                <div class="flex items-center gap-3 mt-3 sm:mt-0">
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold text-white flex items-center" style="background-color: ${colors.primary}">
                                        <span class="mr-1">üöö</span>
                                        ${pkg.carrier}
                                    </span>
                                    <button onclick="refreshPackage(${pkg.id})" class="text-gray-600 hover:text-gray-800 text-lg">üîÑ</button>
                                    <button onclick="removePackage(${pkg.id})" class="text-red-600 hover:text-red-800 text-lg">‚ùå</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                                <div>
                                    <p class="font-semibold text-gray-700">Status</p>
                                    <p style="color: ${colors.primary}">${pkg.status}</p>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-700 flex items-center">
                                        <span class="mr-1">‚è∞</span>
                                        Estimated Delivery
                                    </p>
                                    <p style="color: ${colors.primary}">${pkg.estimated_delivery}</p>
                                    ${daysDisplay ? `<p class="mt-1">${daysDisplay}</p>` : ''}
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-700">Last Update</p>
                                    <p class="text-gray-600">${pkg.last_update}</p>
                                </div>
                            </div>
                            ${pkg.location ? `
                                <div class="mt-3 text-sm">
                                    <p class="font-semibold text-gray-700">Current Location</p>
                                    <p style="color: ${colors.primary}">${pkg.location}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Event listeners
        document.getElementById('add-btn').addEventListener('click', addPackage);
        document.getElementById('tracking-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPackage();
        });
        document.getElementById('nickname-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPackage();
        });

        // Initialize app
        if (SUPABASE_URL && SUPABASE_KEY && 
            SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE' && 
            SUPABASE_KEY !== 'YOUR_SUPABASE_ANON_KEY_HERE') {
            loadPackages();
        } else {
            updateStatus('‚ö†Ô∏è Database not configured - using local storage only', 'yellow');
            loadFromLocalStorage();
        }
    </script>
</body>
</html>
